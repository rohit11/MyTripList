name: Check Cherry-Pick Status

on:
  pull_request:
    branches:
      - release/*  # Trigger on all release branches

jobs:
  check-cherry-pick:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get Current Branch and PR Details
        run: |
          PR_BRANCH="${{ github.head_ref }}"
          BASE_BRANCH="${{ github.base_ref }}"
          echo "PR_BRANCH=${PR_BRANCH}" >> $GITHUB_ENV
          echo "BASE_BRANCH=${BASE_BRANCH}" >> $GITHUB_ENV

      - name: Get List of Release Branches
        run: |
          RELEASE_BRANCHES=$(git branch -r | grep "release/" | sed 's/origin\///')
          echo "Release branches found: $RELEASE_BRANCHES"

          # Ensure BASE_BRANCH is escaped correctly
          ESCAPED_BASE_BRANCH=$(echo "$BASE_BRANCH" | sed 's/[\/&]/\\&/g')

          # Use awk to get all branches after the base branch
          NEXT_BRANCHES=$(echo "$RELEASE_BRANCHES" | awk "/$ESCAPED_BASE_BRANCH/{flag=1; next} flag" | tr '\n' ' ')
          echo "NEXT_BRANCHES=${NEXT_BRANCHES}" >> $GITHUB_ENV

      - name: Check for Missing Cherry-Picks
        run: |
          MISSING_BRANCHES=""
          for branch in $NEXT_BRANCHES; do
            if ! git branch -r --contains $GITHUB_SHA | grep -q "$branch"; then
              MISSING_BRANCHES+="$branch "
            fi
          done

          if [ -n "$MISSING_BRANCHES" ]; then
            echo "::error::Cherry-pick required for: $MISSING_BRANCHES"
            exit 1
          else
            echo "All relevant branches are up-to-date."
          fi
